name: DevSecOps Pipeline - Java WebApp

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # allows manual trigger

jobs:
  build-and-secure:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build with Maven
      run: mvn clean install

    - name: Run Unit Tests
      run: mvn test

    # üõ°Ô∏è Black Duck SCA
    - name: Run Black Duck Scan
      uses: synopsys-sig/synopsys-action@v1.8.0
      with:
        blackduck_url: ${{ secrets.BLACKDUCK_URL }}
        blackduck_token: ${{ secrets.BLACKDUCK_API_TOKEN }}
        scan_full: true

    # üß† Coverity SAST
    - name: Run Coverity Scan
      env:
        COVERITY_USER: ${{ secrets.COVERITY_USER }}
        COVERITY_PASSPHRASE: ${{ secrets.COVERITY_PASSWORD }}
      run: |
        wget https://scan.coverity.com/download/linux64 --post-data "token=$COVERITY_PASSPHRASE&project=MyJavaWebApp" -O coverity_tool.tgz
        mkdir coverity
        tar -xvzf coverity_tool.tgz -C coverity --strip-components=1
        export PATH=$PATH:$PWD/coverity/bin
        ./coverity/bin/cov-build --dir cov-int mvn clean compile
        tar czvf project.tgz cov-int
        curl --form token=$COVERITY_PASSPHRASE \
             --form email=$COVERITY_USER \
             --form file=@project.tgz \
             --form version="main" \
             --form description="Java Web App analysis" \
             https://scan.coverity.com/builds?project=MyJavaWebApp
